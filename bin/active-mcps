#!/usr/bin/env bash
# Detect active MCP servers with caching

CACHE_FILE="/tmp/active-mcps-cache"
CACHE_TTL=10

if [[ -f "$CACHE_FILE" ]]; then
    mtime=$(stat -f %m "$CACHE_FILE" 2>/dev/null || stat -c %Y "$CACHE_FILE" 2>/dev/null)
    now=$(date +%s)
    if (( now - mtime < CACHE_TTL )); then
        cat "$CACHE_FILE"
        exit 0
    fi
fi

scan_mcps() {
    ps aux 2>/dev/null | grep -oE '(mcp-server-[a-zA-Z0-9-]+|[c]hrome-devtools-mcp|mcp-remote[[:space:]]+https?://[^[:space:]]+)' | \
    while read -r line; do
        if [[ "$line" == mcp-server-* ]]; then
            echo "${line#mcp-server-}"
        elif [[ "$line" == "chrome-devtools-mcp" ]]; then
            echo "chrome"
        elif [[ "$line" == *roktgpt* ]]; then
            echo "roktgpt"
        elif [[ "$line" == mcp-remote* ]]; then
            echo "remote"
        fi
    done | sort -u | tr '\n' ' ' | sed 's/ $//'
}

result=$(scan_mcps)
echo "$result" > "$CACHE_FILE"
echo "$result"
